<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wieloosobowa Przygoda AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-cinzel { font-family: 'Cinzel Decorative', cursive; }
        #story-container::-webkit-scrollbar { width: 8px; }
        #story-container::-webkit-scrollbar-track { background: #2d3748; }
        #story-container::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
        #story-container::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        .ai-message { background-color: rgba(255, 255, 255, 0.05); border-left: 2px solid #a78bfa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .user-message { border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #a78bfa; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .tab-btn.active { border-color: #facc15; background-color: #facc1520; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" v-cloak class="container mx-auto max-w-4xl h-screen flex flex-col p-2 sm:p-4">
        
        <!-- Login/Session Screen -->
        <div v-if="gameState === 'session'" class="flex flex-col items-center justify-center h-full">
            <h1 class="text-4xl sm:text-5xl font-cinzel text-yellow-300 mb-4 text-center">Wieloosobowa Przygoda AI</h1>
            <p class="text-violet-300 mb-8 text-center">Stw√≥rzcie wsp√≥lnie swojƒÖ historiƒô.</p>
            <div class="w-full max-w-sm p-8 bg-gray-800 rounded-lg shadow-xl space-y-6">
                <button @click="createNewGame" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105">Stw√≥rz NowƒÖ Grƒô</button>
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400">LUB</span><div class="flex-grow border-t border-gray-600"></div>
                </div>
                <div class="space-y-2">
                    <input type="text" v-model="sessionToJoin" placeholder="Wpisz kod sesji..." class="w-full bg-gray-700 text-gray-200 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-violet-400">
                    <button @click="joinGame" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105">Do≈ÇƒÖcz do Gry</button>
                </div>
                 <div class="pt-4">
                    <label for="api-key-input" class="block text-sm font-medium text-gray-400 mb-1">Klucz API Gemini</label>
                    <input type="password" id="api-key-input" v-model="apiKey" placeholder="Wprowad≈∫ klucz API..." class="w-full bg-gray-700 text-gray-200 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-violet-400">
                </div>
            </div>
            <p v-if="error" class="text-red-400 mt-4">{{ error }}</p>
        </div>

        <!-- Character Creation Screen -->
        <div v-else-if="gameState === 'character_creation'" class="flex flex-col items-center justify-center h-full">
            <h2 class="text-3xl font-cinzel text-yellow-300 mb-2">Kod Sesji: <span class="text-white font-sans tracking-widest bg-gray-700 px-2 py-1 rounded">{{ sessionId }}</span></h2>
            <p class="text-violet-300 mb-6">Udostƒôpnij ten kod znajomym, aby do≈ÇƒÖczyli.</p>
            
            <div class="w-full max-w-lg p-6 bg-gray-800 rounded-lg shadow-xl">
                <div v-if="!playerCharacter.name">
                    <h3 class="text-2xl font-bold mb-4 text-center">Stw√≥rz swojƒÖ postaƒá</h3>
                    <div class="space-y-4">
                         <input type="text" v-model="charCreation.name" placeholder="Imiƒô postaci..." maxlength="20" class="w-full bg-gray-700 text-gray-200 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-violet-400">
                         <textarea v-model="charCreation.description" placeholder="Opis wyglƒÖdu i charakteru..." rows="3" class="w-full bg-gray-700 text-gray-200 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-violet-400"></textarea>
                         <button @click="createCharacter" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Zatwierd≈∫ Postaƒá</button>
                    </div>
                </div>
                <div v-else class="text-center">
                    <h3 class="text-2xl font-bold mb-4">Witaj, {{ playerCharacter.name }}!</h3>
                    <p class="text-gray-400">Poczekaj, a≈º reszta graczy stworzy swoje postacie...</p>
                    <button v-if="isHost && session.players.length > 0" @click="startGame" class="mt-6 bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Rozpocznij Przygodƒô!</button>
                </div>
                 <div class="mt-6">
                    <h4 class="font-bold text-lg mb-2">Gracze w sesji ({{ session.players.length }}/3):</h4>
                    <ul class="list-disc list-inside text-gray-300">
                        <li v-for="player in session.players" :key="player.uid">{{ player.name }}</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div v-else-if="gameState === 'playing'" class="flex flex-col h-full">
             <header class="text-center py-2 sm:py-4 border-b-2 border-violet-400 mb-4 flex justify-between items-center">
                <div class="text-left">
                    <p class="text-sm text-gray-400">Kod Sesji</p>
                    <p class="font-bold tracking-widest">{{ sessionId }}</p>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-4xl font-cinzel text-yellow-300">Wieloosobowa Przygoda AI</h1>
                </div>
                <button @click="openJournal" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-3 rounded-lg transition-colors duration-300 text-sm">Dziennik</button>
            </header>

            <main ref="storyContainer" class="flex-1 overflow-y-auto p-4 bg-gray-800 rounded-lg shadow-inner">
                 <div v-for="entry in session.chatHistory" :key="entry.timestamp">
                     <div v-if="entry.role === 'model'" class="ai-message" v-html="formatMessage(entry.parts[0].text)"></div>
                     <div v-else class="user-message" :style="{ borderColor: getPlayerColor(entry.uid) }">
                         <p class="font-bold mb-1" :style="{ color: getPlayerColor(entry.uid) }">{{ entry.playerName }} {{ entry.actionType }}:</p>
                         <p class="whitespace-pre-wrap">{{ entry.parts[0].text }}</p>
                     </div>
                 </div>
            </main>

            <footer class="mt-4">
                <div v-if="isAITurn" class="text-center mb-2"><div class="loader mx-auto"></div><p class="text-violet-300 mt-2">AI tworzy dalszy ciƒÖg historii...</p></div>
                <div v-else>
                     <button @click="callAI" class="w-full mb-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Kontynuuj Historiƒô</button>
                    <div class="flex flex-col sm:flex-row items-center bg-gray-800 p-2 rounded-lg shadow-lg">
                        <input type="text" v-model="userInput" @keydown.enter="sendAction('Robiƒô')" placeholder="Wpisz swojƒÖ akcjƒô..." class="w-full bg-gray-700 text-gray-200 rounded-md sm:rounded-l-md sm:rounded-r-none p-3 focus:outline-none focus:ring-2 focus:ring-violet-400 transition mb-2 sm:mb-0">
                        <div class="flex w-full sm:w-auto">
                            <button @click="sendAction('M√≥wiƒô')" class="action-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 transition-colors duration-300 sm:rounded-none" title="M√≥w">...</button>
                            <button @click="sendAction('Robiƒô')" class="action-btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 transition-colors duration-300" title="R√≥b">‚ö°</button>
                            <button @click="sendAction('Opisujƒô')" class="action-btn flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-r-md sm:rounded-l-none" title="Opisz">üëÅÔ∏è</button>
                        </div>
                    </div>
                </div>
            </footer>
        </div>

    </div>
    
    <!-- Journal Modal will be implemented later -->

    <!-- Firebase and Vue.js scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { createApp, ref, onMounted, computed, nextTick } = Vue;

        const app = createApp({
            setup() {
                // State
                const gameState = ref('session'); // session, character_creation, playing
                const apiKey = ref(localStorage.getItem('mpApiKey') || '');
                const sessionToJoin = ref('');
                const sessionId = ref(null);
                const error = ref('');
                const user = ref(null);
                const session = ref(null);
                const charCreation = ref({ name: '', description: '' });
                const userInput = ref('');
                const storyContainer = ref(null);
                const isAITurn = ref(false);
                let unsubscribe = null; // To store the onSnapshot listener

                // Firebase Refs
                let auth, db;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // Computed Properties
                const playerCharacter = computed(() => {
                    if (!user.value || !session.value?.players) return {};
                    return session.value.players.find(p => p.uid === user.value.uid) || {};
                });
                const isHost = computed(() => {
                    if (!user.value || !session.value?.host) return false;
                    return session.value.host === user.value.uid;
                });
                
                // --- Lifecycle ---
                onMounted(async () => {
                    try {
                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        const firebaseApp = initializeApp(firebaseConfig);
                        db = getFirestore(firebaseApp);
                        auth = getAuth(firebaseApp);
                        
                        onAuthStateChanged(auth, async (currentUser) => {
                            if (currentUser) {
                                user.value = currentUser;
                            } else {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            }
                        });

                    } catch(e) {
                        console.error("Firebase Init Error:", e);
                        error.value = "Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z serwerem gry.";
                    }
                });

                // --- Methods ---
                function getPlayerColor(uid) {
                    const colors = ['#34D399', '#FBBF24', '#F87171'];
                    if (!session.value?.players) return '#FFFFFF';
                    const index = session.value.players.findIndex(p => p.uid === uid);
                    return colors[index % colors.length];
                }

                function formatMessage(text) {
                     return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                }

                async function createNewGame() {
                    if (!user.value || !apiKey.value) {
                        error.value = "Musisz byƒá zalogowany i podaƒá klucz API.";
                        return;
                    }
                    localStorage.setItem('mpApiKey', apiKey.value);
                    const newSessionId = collection(db, "sessions")._path.root + Math.random().toString(36).substring(2, 8).toUpperCase();
                    sessionId.value = newSessionId;
                    
                    const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, newSessionId);
                    
                    const newSessionData = {
                        host: user.value.uid,
                        players: [],
                        chatHistory: [],
                        journal: { characters: [], plotPoints: [], locations: [] },
                        gameState: 'character_creation',
                        createdAt: serverTimestamp(),
                        lastAIUpdate: null,
                    };

                    await setDoc(sessionRef, newSessionData);
                    joinSession(newSessionId);
                }

                async function joinGame() {
                    if (!sessionToJoin.value) {
                         error.value = "Wpisz kod sesji.";
                         return;
                    }
                     if (!apiKey.value) {
                        error.value = "Musisz podaƒá klucz API.";
                        return;
                    }
                    localStorage.setItem('mpApiKey', apiKey.value);
                    joinSession(sessionToJoin.value.toUpperCase());
                }

                function joinSession(id) {
                    if (unsubscribe) unsubscribe(); // Unsubscribe from previous listener if any
                    
                    const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, id);
                    
                    unsubscribe = onSnapshot(sessionRef, (docSnap) => {
                        if (docSnap.exists()) {
                            session.value = docSnap.data();
                            sessionId.value = id;
                            gameState.value = session.value.gameState;
                            error.value = '';
                            
                            // Scroll to bottom on new messages
                            if (gameState.value === 'playing') {
                                nextTick(() => {
                                   if (storyContainer.value) {
                                       storyContainer.value.scrollTop = storyContainer.value.scrollHeight;
                                   }
                                });
                            }
                        } else {
                            error.value = "Nie znaleziono sesji o takim kodzie.";
                            unsubscribe();
                        }
                    }, (err) => {
                        console.error("Snapshot error:", err);
                        error.value = "B≈ÇƒÖd po≈ÇƒÖczenia z sesjƒÖ.";
                    });
                }
                
                async function createCharacter() {
                    if (!charCreation.value.name || !charCreation.value.description) {
                        error.value = "Imiƒô i opis nie mogƒÖ byƒá puste.";
                        return;
                    }
                    if (session.value.players.length >= 3) {
                         error.value = "Sesja jest ju≈º pe≈Çna.";
                         return;
                    }

                    const newPlayer = {
                        uid: user.value.uid,
                        name: charCreation.value.name,
                        description: charCreation.value.description,
                        power: Math.floor(Math.random() * 50) + 1,
                        title: 'Nieobudzony'
                    };
                    
                    const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, sessionId.value);
                    await updateDoc(sessionRef, {
                        players: arrayUnion(newPlayer)
                    });
                }
                
                async function startGame() {
                    const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, sessionId.value);
                    
                    let initialStory = "Rozpoczynacie swojƒÖ przygodƒô. Jeste≈õcie grupƒÖ 15-latk√≥w, kt√≥rzy po raz pierwszy stajƒÖ przed magicznƒÖ kulƒÖ, aby poznaƒá swojƒÖ moc.\n";
                    session.value.players.forEach(p => {
                        initialStory += `\n**${p.name}**, ${p.description}, podchodzi do kuli. Jej moc to **${p.power}**, a tytu≈Ç to **'${p.title}'**.`
                    });
                    initialStory += "\n\nStary Mag, opiekun kuli, u≈õmiecha siƒô do was. 'Ka≈ºda wielka podr√≥≈º zaczyna siƒô od pierwszego kroku. Co teraz zrobicie?'"

                    await updateDoc(sessionRef, {
                        gameState: 'playing',
                        chatHistory: arrayUnion({
                            role: 'model',
                            parts: [{ text: initialStory }],
                            timestamp: Date.now()
                        })
                    });
                }
                
                async function sendAction(actionType) {
                    if (!userInput.value.trim()) return;
                    const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, sessionId.value);
                    
                    await updateDoc(sessionRef, {
                        chatHistory: arrayUnion({
                            role: 'user',
                            uid: user.value.uid,
                            playerName: playerCharacter.value.name,
                            actionType: actionType,
                            parts: [{ text: userInput.value.trim() }],
                            timestamp: Date.now()
                        })
                    });
                    userInput.value = '';
                }

                async function callAI() {
                    // TODO: Implement AI call logic
                    // 1. Get last AI message timestamp from session.lastAIUpdate
                    // 2. Filter chatHistory for user messages after that timestamp
                    // 3. Construct a prompt for the AI
                    // 4. Call Gemini API
                    // 5. Update chatHistory and session.lastAIUpdate in Firestore
                     addMessageToStory("Funkcja AI jest w trakcie implementacji!", 'model');
                }
                
                function openJournal() {
                    alert("Dziennik jest w trakcie implementacji!");
                }
                
                 function addMessageToStory(text, role) {
                     const sessionRef = doc(db, `/artifacts/${appId}/public/data/mp_adventures`, sessionId.value);
                     updateDoc(sessionRef, {
                         chatHistory: arrayUnion({
                             role: role,
                             parts: [{ text: text }],
                             timestamp: Date.now()
                         })
                     });
                 }


                return {
                    gameState,
                    apiKey,
                    sessionToJoin,
                    sessionId,
                    error,
                    user,
                    session,
                    charCreation,
                    userInput,
                    isAITurn,
                    playerCharacter,
                    isHost,
                    storyContainer,
                    createNewGame,
                    joinGame,
                    createCharacter,
                    startGame,
                    sendAction,
                    callAI,
                    openJournal,
                    getPlayerColor,
                    formatMessage
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
